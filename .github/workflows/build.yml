name: MacOS Build for GNU Emacs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Install GNU M4
        run: |
          curl -O https://ftp.gnu.org/gnu/m4/m4-1.4.20.tar.gz
          tar -zxf m4-1.4.20.tar.gz && cd m4-1.4.20
          ./configure && make -j4
          sudo make install
      - name: Install GNU Autoconf
        run: |
          curl -O https://ftp.gnu.org/gnu/autoconf/autoconf-2.72.tar.gz
          tar -zxf autoconf-2.72.tar.gz && cd autoconf-2.72
          ./configure && make -j4
          sudo make install
      - name: Install GNU Automake
        run: |
          curl -O https://ftp.gnu.org/gnu/automake/automake-1.18.tar.gz
          tar -zxf automake-1.18.tar.gz && cd automake-1.18
          ./configure && make -j4
          sudo make install
      - name: Install GNU Libtool
        run: |
          curl -O https://ftp.gnu.org/gnu/libtool/libtool-2.5.4.tar.gz
          tar -zxf libtool-2.5.4.tar.gz && cd libtool-2.5.4
          ./configure && make -j4
          sudo make install
      - name: Install GNU Texinfo
        run: |
          curl -O https://ftp.gnu.org/gnu/texinfo/texinfo-7.2.tar.gz
          tar -zxf texinfo-7.2.tar.gz && cd texinfo-7.2
          ./configure && make -j4
          sudo make install
      - name: Install GNU Libiconv
        run: |
          curl -O https://ftp.gnu.org/gnu/libiconv/libiconv-1.18.tar.gz
          tar -zxf libiconv-1.18.tar.gz && cd libiconv-1.18
          ./configure && make -j4
          sudo make install
      - name: Install GNU Gettext
        run: |
          curl -O https://ftp.gnu.org/gnu/gettext/gettext-0.26.tar.gz
          tar -zxf gettext-0.26.tar.gz && cd gettext-0.26
          ./configure && make -j4
          sudo make install
      - name: Install GNU Ncurses
        run: |
          curl -O https://ftp.gnu.org/gnu/ncurses/ncurses-6.5.tar.gz
          tar -zxf ncurses-6.5.tar.gz && cd ncurses-6.5
          ./configure && make -j4
          sudo make install
      - name: Install Zlib
        run: |
          curl -O https://www.zlib.net/zlib-1.3.1.tar.gz
          tar -zxf zlib-1.3.1.tar.gz && cd zlib-1.3.1
          ./configure && make -j4
          sudo make install
      - name: Install Libxml2
        run: |
          curl -O https://download.gnome.org/sources/libxml2/2.9/libxml2-2.9.9.tar.xz
          tar -Jxf libxml2-2.9.9.tar.xz && cd libxml2-2.9.9
          ./configure && make -j4
          sudo make install
      - name: Install Libffi
        run: |
          curl -LO https://github.com/libffi/libffi/releases/download/v3.5.2/libffi-3.5.2.tar.gz
          tar -Jxf libffi-3.5.2.tar.gz && cd libffi-3.5.2
          ./configure && make -j4
          sudo make install
      - name: Install OpenSSL
        run: |
          curl -LO https://github.com/openssl/openssl/releases/download/openssl-3.6.0/openssl-3.6.0.tar.gz
          tar -zxf openssl-3.6.0.tar.gz && cd openssl-3.6.0
          ./config no-asm && make -j4
          sudo make install
      - name: Install Libexpat
        run: |
          curl -LO https://github.com/libexpat/libexpat/releases/download/R_2_7_3/expat-2.7.3.tar.gz
          tar -zxf expat-2.7.3.tar.gz && cd expat-2.7.3
          ./configure && make -j4
          sudo make install
      - name: Install Libnettle
        run: |
          curl -O https://ftp.gnu.org/gnu/nettle/nettle-3.10.2.tar.gz
          tar -zxf nettle-3.10.2.tar.gz && cd nettle-3.10.2
          ./configure && make -j4
          sudo make install
      - name: Install GNU Libgmp
        run: |
          curl -O https://ftp.gnu.org/gnu/gmp/gmp-6.3.0.tar.gz
          tar -zxf gmp-6.3.0.tar.gz && cd gmp-6.3.0
          ./configure && make -j4
          sudo make install
      - name: Install GNU Libtasn1
        run: |
          curl -O https://ftp.gnu.org/gnu/libtasn1/libtasn1-4.20.0.tar.gz
          tar -zxf libtasn1-4.20.0.tar.gz && cd libtasn1-4.20.0
          ./configure && make -j4
          sudo make install
      - name: Install P11-kit
        run: |
          curl -LO https://github.com/p11-glue/p11-kit/releases/download/0.25.10/p11-kit-0.25.10.tar.xz
          tar -Jxf p11-kit-0.25.10.tar.xz && cd p11-kit-0.25.10
          ./configure && make -j4
          sudo make install
      - name: Install Libidn2
        run: |
          curl -O https://ftp.gnu.org/gnu/libidn/libidn2-2.3.8.tar.gz
          tar -zxf libidn2-2.3.8.tar.gz && cd libidn2-2.3.8
          ./configure && make -j4
          sudo make install
      - name: Install Libunbound
        run: |
          curl -O https://nlnetlabs.nl/downloads/unbound/unbound-1.24.2.tar.gz
          tar -zxf unbound-1.24.2.tar.gz && cd unbound-1.24.2
          ./configure && make -j4
          sudo make install
      - name: Install Gnutls
        run: |
          curl -O https://www.gnupg.org/ftp/gcrypt/gnutls/v3.8/gnutls-3.8.11.tar.xz
          tar -Jxf gnutls-3.8.11.tar.xz && cd gnutls-3.8.11
          ./configure && make -j4
          sudo make install
      - name: Install Libtreesitter
        run: |
          curl -LO https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v0.25.10.tar.gz
          tar -zxf v0.25.10.tar.gz && cd v0.25.10
          make -j4
          sudo make install
      - name: Install Emacs
        run: |
          git clone -b 'feature/igc' --depth 1 https://github.com/emacs-mirror/emacs.git
          cd emacs && ./autogen.sh
          CFLAGS='-O3 -static' ./configure --disable-gc-mark-trace    \
                                           --without-all              \
                                           --with-gnutls              \
                                           --with-mps                 \
                                           --with-native-image-api    \
                                           --with-ns                  \
                                           --with-small-ja-dic        \
                                           --with-toolkit-scroll-bars \
                                           --with-tree-sitter         \
                                           --with-xml2                \
                                           --with-xwidgets            \
                                           --with-zlib
          make -j4 && make install
          tar -Jcf emacs-igc-static-mach-arm64.tar.xz nextstep/Emacs.app
      - uses: actions/upload-artifact@v4
        with:
          name: emacs-build
          path: emacs/emacs-igc-static-mach-arm64.tar.xz
